name: query conda package from prefix.dev hosted channel
on:
  workflow_call:
  workflow_dispatch:
   inputs:
      channel:
        description: 'Channel'
        required: true
        options: [sofa-framework-devel]
        default: 'sofa-framework-devel'
      platform:
        description: 'Platform'
        required: true
        type: choice
        options: [linux-64, linux-aarch64, osx-64, osx-arm64, win-64]
        default: 'linux-64'
      package:
        description: 'Package name'
        required: true
        type: string
        default: 'libsofa'
jobs:
  remove-conda-package-from-prefix:
    name:  "packages on ${{ inputs.runner }}"
    runs-on: ubuntu-slim
    steps:
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Query prefix.dev GraphQL API
      id: query
      run: |
        response=$(curl -s -X POST https://prefix.dev/graphql \
          -H "Content-Type: application/json" \
          -d '{
            "query": "query { channel(name: \"sofa-framework\") { packages(first: 100) { nodes { name versions(first: 50) { nodes { version files { filename size sha256 } } } } } } }"
          }')

        echo "$response" > response.json

    - name: Extract libsofa files
      run: |
        jq '.data.channel.packages.nodes[]
            | select(.name=="libsofa")
            | .versions.nodes[]
            | .files[]' response.json > libsofa-files.json

        echo "Found files:"
        cat libsofa-files.json
    # - name: Remove existing package
    #   shell: bash -l {0}
    #   run: |
    #     echo "curl -X DELETE https://prefix.dev/api/v1/delete/${{ inputs.channel }}/${{ inputs.platform }}/${{ inputs.filename }} -H \"Authorization: Bearer --secrets--\""
